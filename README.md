# Проектная работа "Веб-ларек"

Стек: HTML, SCSS, TS, Webpack

Структура проекта:
- src/ — исходные файлы проекта
- src/components/base/ — папка с базовым кодом
- src/components/Model/ — компоненты слоя данных
- src/components/View/ — компоненты слоя представления
- src/utils/ — вспомогательные утилиты и константы

Важные файлы:
- src/pages/index.html — HTML-файл главной страницы
- src/types/index.ts — файл с типами
- src/index.ts — точка входа приложения
- src/scss/styles.scss — корневой файл стилей
- src/utils/constants.ts — файл с константами

## Установка и запуск
Для установки и запуска проекта необходимо выполнить команды

```
npm install
npm run start
```

## Сборка

```
npm run build
```

## Данные и типы данных, используемые в приложении

Идентификатор товара

```
type TItemId = string;
```

Данные товара

```
type TItem = {
  id: TItemId;
  title: string;
  description: string;
  image: string;
  category: string;
  price: number | null;
}
```

Получаемые с сервера данные о товарах

```
type TItemsAPI = {
  items: TItem[];
  total: number;
}
```

Расширенный тип данных о товаре. Добавлено значение цены товара с указанием валюты, полная ссылка на изображение товара, css-класс для цвета фона строки текста наименования категории товара.

```
type TItemView = TItem & {
  priceString: string;
  imageLink: string;
  categoryClass: string;
}
```

Варианты оплаты

```
type TPaymentType = 'online' | 'cash';
```

Данные заказа

```
type TOrder = {
  payment: TPaymentType;
  address: string;
  email: string;
  phone: string;
  itemIds: TItemId[];
  total: number;
}
```

Результат отправки заказа на сервер

```
type TOrderResult = {
  id: string;
  total: number;
}
```



## Архитектура приложения

Код приложения разделен на слои согласно парадигме MVP: 
- слой представления, отвечает за отображение данных на странице, 
- слой данных, отвечает за хранение и изменение данных
- презентер, отвечает за связь представления и данных.

### Базовый код

#### Класс Api

Содержит в себе базовую логику отправки запросов. В конструктор передается базовый адрес сервера и опциональный объект с заголовками запросов.
Методы: 
- `get` - выполняет GET запрос на переданный в параметрах ендпоинт и возвращает промис с объектом, которым ответил сервер
- `post` - принимает объект с данными, которые будут переданы в JSON в теле запроса, и отправляет эти данные на ендпоинт, переданный как параметр при вызове метода. По умолчанию выполняется `POST` запрос, но метод запроса может быть переопределен заданием третьего параметра при вызове.

#### Класс EventEmitter
Брокер событий позволяет отправлять события и подписываться на события, происходящие в системе. Класс используется в презентере для обработки событий и в слоях приложения для генерации событий.  
Основные методы, реализуемые классом, описаны интерфейсом `IEvents`:
- `on` - подписка на событие
- `emit` - инициализация события
- `trigger` - возвращает функцию, при вызове которой инициализируется требуемое в параметрах событие   

### Слой данных

#### Класс ItemsList
Класс отвечает за хранение и логику работы с данными товаров.

В полях класса хранятся данные о товарах:
- items: TItemView[];

Класс предоставляет набор методов для взаимодействия с этими данными:
- setItems(items: TItem[]): void; - загружает массив товаров в класс
- getAllItems(): TItemView[]; - возвращает полный массив товаров
- getItems(itemIds: TItemId[]): TItemView[]; - возвращает массив товаров по их Id
- getItem(itemId: TItemId): TItemView; - - возвращает товар по его Id

Вспомогательные защищенные методы:
- getCategoryClass(category: string): string; - возвращает css-класс для цвета фона строки текста наименования категории товара по его категории
- getImageLink(image: string, cdnUrl: string, imageFormat: string): string; - собирает полную ссылку на изображение товара из наименования файла, url хранилища изображений, и формата изображений


#### Класс Basket
Класс отвечает за хранение и логику работы с корзиной товаров.

В полях класса хранятся следующие данные:
- itemIds: TItemId[]; - массив id товаров
- total: number | null; - общая стоимость товаров в корзине
- count: number; - количество товаров в корзине
- events: IEvents - экземпляр класса `EventEmitter` для инициации событий при изменении данных

Класс предоставляет набор методов для взаимодействия с этими данными:
- addItem(id: TItemId): void; - добавляет id товара в корзину
- removeItem(id: TItemId): void; - удаляет товар из корзины по id
- reset(): void; - очищает корзину
- getItemIds(): TItemId[]; - возвращает список id товаров в корзине
- getTotal(): number | null; - возвращает общую стоимость товаров в корзине
- getTotalString(itemsList: IItemsList): string; - возвращает общую стоимость товаров в корзине с указанием валюты
- getCount(): number; - возвращает количество товаров в корзине
- checkItem(itemIdForCheck: TItemId): boolean - проверяет наличие товара в корзине

#### Класс OrderData
Класс отвечает за хранение и логику работы с данными заказа.

В полях класса хранятся следующие данные:
- payment: TPaymentType; - способ оплаты
- address: string; - адрес покупателя
- email: string; - электронная почта покупателя
- phone: string; - телефон покупателя
- itemIds: TItemId[]; - список id товаров в заказе
- total: number; - общая стоимость товаров в заказе

Класс предоставляет набор методов для взаимодействия с этими данными:
- setOrderData(data: Partial\<TOrder>): void; - сохраняет данные заказа в классе
- getOrderData(): TOrder; - возвращает данные заказа


### Классы представления
Все классы представления отвечают за отображение внутри контейнера (DOM-элемент) передаваемых в них данных.

#### Классы представления модальных окон

##### Абстрактный класс Modal
Содержит общие элементы для реализации модальных окон. Предоставляет методы `show` и `hide` для управления отображением модального окна. Устанавливает слушатели на клавиатуру, для закрытия модального окна по Esc, на клик в оверлей и кнопку-крестик для закрытия модального окна.

- constructor(modalRoot: HTMLElement, templateModal: HTMLTemplateElement, events: IEvents)

Конструктор принимает корневой элемент модального окна, корневой элемент шаблона из разметки, и экземпляр класса `EventEmitter`.

Поля класса:
- modalRoot: HTMLElement; - корневой элемент модального окна
- templateRoot: HTMLElement; - элемент модального окна для вставки в него шаблона
- templateModal: HTMLTemplateElement; - корневой элемент исходного шаблона
- container: HTMLElement; - редактируемая копия шаблона
- buttonClose: HTMLButtonElement; - кнопка закрытия
- events: IEvents; - экземпляр класса `EventEmitter`
- buttonMain: HTMLButtonElement; - основная кнопка (кнопка перехода к следующему этапу оформления заказа)

Методы:
- show(): void; - заменяет содержимое "шаблонной части" модального окна на подготовленное (актуальное) содержимое из `container`, открывает модальное окно, устанавливает слушатель на клавиатуру, для закрытия модального окна по Esc
- hide(): void; - закрывает модальное окно, удаляет слушатель клавиатуры

Вспомогательные методы:
- removeChildren(elem: HTMLElement): void; - удаляет все дочерние элементы
- handleCloseModalByEscape(evt: KeyboardEvent): void; - обработчик нажатия на Esc

##### Класс ModalCardPreview
Отвечает за отображение модального окна карточки с подробной информацией о товаре.

Дополнительное поле:
- item: TItemView; - данные о товаре

Дополнительный метод:
- setItem(item: TItemView, inBasket: boolean): void; - подготавливает `container`, на основе данных о товаре и информации о наличии товара в корзине

##### Класс ModalBasket
Отвечает за отображение модального окна с корзиной товаров.
- constructor(modalRoot: HTMLElement, templateModal: HTMLTemplateElement, templateItem: HTMLTemplateElement, events: IEvents)

В конструктор принимает дополнительный параметр `templateItem` с шаблоном для отображения каждого отдельного товара в корзине.

Дополнительные поля:
- items: TItemView[]; - массив данных о товарах в корзине
- templateItemRoot: HTMLElement; - корневой элемент списка товаров
- templateItem: HTMLTemplateElement; - шаблон для отображения каждого отдельного товара в корзине
- total: HTMLElement; - элемент для отображения общей стоимости товаров в корзине
- title: HTMLElement; - заголовок модального окна

Дополнительный метод:
- setItems(items: TItemView[], total: string, buttonEnabled: boolean): void; - подготавливает `container`, на основе массива данных о товарах в корзине, их сумме, и информации о возможности заказа текущего набора товаров

##### Класс ModalOrder 
Отвечает за отображение модального окна с вводом способа оплаты и адреса.

Дополнительные поля:
- addressElement: HTMLInputElement; - элемент ввода адреса
- buttonPaymentCard: HTMLButtonElement; - кнопка варианта оплаты "Онлайн"
- buttonPaymentCash: HTMLButtonElement; - кнопка варианта оплаты "При получении"
- buttonsPayment: HTMLElement; - контейнер с кнопками вариантов оплаты
- errors: HTMLElement; - элемент для отображения ошибок
- payment: TPaymentType; - выбранный вариант оплаты
- address: string; - введенный адрес
- validAddress: boolean; - корректность введенного адреса (его наличие)
- validPayment: boolean; - корректность выбранного способа оплаты (наличие произведенного выбора)
- validationActive: boolean; - активность инструментов валидации. Валидация включается после первой попытки нажатия на кнопку перехода к следующему этапу оформления заказа.

Дополнительный метод:
- init(): void; - подготавливает `container`, устанавливает слушатели на элементы интерфейса

Вспомогательные защищенные методы:
- activateValidation(): void; - включает валидацию
- updateAddressState(): void; - обновляет информацию о заполненности поля ввода адреса
- updatePaymentButtonsState(): void; - обновляет оформление кнопок способа оплаты
- updateErrorText(): void; - обновляет текст ошибок
- updateMainButtonStatus(): void; - обновляет доступность кнопки перехода к следующему этапу оформления заказа

##### Класс ModalContacts
Отвечает за отображение модального окна с вводом электронной почты и номера телефона.

Дополнительные поля:
- emailElement: HTMLInputElement; - элемент ввода электронной почты
- phoneElement: HTMLInputElement; - элемент ввода номера телефона
- errors: HTMLElement; - элемент для отображения ошибок
- email: string; - введенная электронная почта
- phone: string; - введенный номер телефона
- validEmail: boolean; - корректность введенной электронной почты (ее наличие)
- validPhone: boolean; - корректность введенного номера телефона (его наличие)
- validationActive: boolean; - активность инструментов валидации. Валидация включается после первой попытки нажатия на кнопку перехода к следующему этапу оформления заказа.

Дополнительный метод:
- init(): void; - подготавливает `container`, устанавливает слушатели на элементы интерфейса

Вспомогательные защищенные методы:
- activateValidation(): void; - включает валидацию
- updateEmailState(): void; - обновляет информацию о заполненности поля ввода электронной почты
- updatePhoneState(): void; - обновляет информацию о заполненности поля ввода номера телефона
- updateErrorText(): void; - обновляет текст ошибок
- updateMainButtonStatus(): void; - обновляет доступность кнопки перехода к следующему этапу оформления заказа

##### Класс ModalSuccess
Отвечает за отображение результата отправки заказа на сервер.

Дополнительные поля:
- result: HTMLElement; - элемент с информацией о результате отправки заказа на сервер
- description: HTMLElement; - элемент с расшифровкой информации о результате отправки заказа на сервер
- imageContainer: HTMLElement; - контейнер с основным изображением модального окна, отражающим результат отправки заказа на сервер

Дополнительный метод:
- set(result: string, description: string, errorMode: boolean): void; - подготавливает `container`, на основе информации о результате отправки заказа на сервер, ее расшифровке, и наличии ошибок


#### Класс ItemView
Отвечает за отображение отдельного товара.  
- constructor (template: HTMLTemplateElement, item: TItemView, serialNumber: number)

В конструктор класса передается необходимый шаблон, данные о конкретном товаре и, опциально, порядковый номер товара для отображения в корзине.

Поля класса:
- container: HTMLElement; - редактируемая копия шаблона
- id: TItemId; - идентификатор товара
- category: HTMLElement; - элемент для отображения категории товара
- title: HTMLElement; - элемент для отображения наименования товара
- image: HTMLImageElement; - элемент для отображения изображения товара
- price: HTMLElement; - элемент для отображения цены товара
- description: HTMLElement; - элемент для отображения описания товара
- serialNumber: HTMLElement; - элемент для отображения порядкового номера товара в корзине

Метод:
- get(): HTMLElement; - возвращает сформированный элемент отображения товара (`container`)

Вспомогательный защищенный метод:
- clearClassListCategories(elem: HTMLElement): void; - очищает css-класс категории товара от всех категорий товаров

#### Класс GalleryView
Отвечает за отображение блока с товарами на главной странице.
- constructor(parent: HTMLElement, template: HTMLTemplateElement, events: IEvents)

В конструктор класса передается корневой элемент для отображения галереи, шаблон для отображения отдельного товара, и экземпляр класса `EventEmitter`.

Поля класса:
- container: DocumentFragment; - контейнер, в котором создается галерея
- parent: HTMLElement; - корневой элемент для отображения галереи
- template: HTMLTemplateElement; - шаблон для отображения отдельного товара
- events: IEvents; - экземпляр класса `EventEmitter`

Методы:
- setItems(items: TItemView[]): void; - подготавливает `container`, на основе массива данных о товарах
- render(): void; - передает сформированную в `container` галерею в корневой элемент для ее отображения

#### Класс HeaderBasketView
Отвечает за отображение блока с иконкой корзины на главной странице, и открытие модального окна с корзиной товаров.
- constructor(basketElement: HTMLButtonElement, events: IEvents)

В конструктор класса передается элемент с иконкой корзины, и экземпляр класса `EventEmitter`.

Поля класса:
- basketElement: HTMLButtonElement; - элемент с иконкой корзины
- counterElement: HTMLElement; - элемент счетчика количества товаров в корзине на иконке корзины
- events: IEvents; - экземпляр класса `EventEmitter`

Метод:
- set counter(itemsCount: number); - сеттер счетчика количества товаров в корзине


### Слой коммуникации

#### Класс WebLarekAPI
Отвечает за взаимодействие с бэкендом сервиса.   
- constructor(baseUrl: string, options?: RequestInit)
В конструктор принимает url сервера и, опциально, набор настроек соединения.

Содержит следующие методы:
- getItems(): Promise\<TItemsAPI>; - загружает с сервера массив товаров
- sendOrder(order: TOrder): Promise\<TOrderResult>; - отправляет заказ на сервер и получает результат отправки

### Вспомогательные утилиты и константы

#### Функция getPriceString
- getPriceString(price: number): string;

Добавляет к числовому значению стоимости наименование валюты в нужном числе и падеже.

#### Константы
- API_URL; - основной url сервера
- CDN_URL; - url сервера с изображениями товаров
- CDN_IMAGES_FORMAT; - формат изображений для загрузки с сервера (svg/png)
- MODAL_DELAY; - задержка (мс) перед открытием следующего модального окна после закрытия предыдущего


## Взаимодействие компонентов
Код, описывающий взаимодействие представления и данных между собой, находится в файле `index.ts`, выполняющем роль презентера. Взаимодействие осуществляется за счет событий генерируемых с помощью брокера событий и обработчиков этих событий, описанных в `index.ts`. В `index.ts` сначала создаются экземпляры всех необходимых классов, а затем настраивается обработка событий.

### Список всех событий, которые могут генерироваться в системе:

#### События изменения данных (генерируются классами моделями данных)
- `basket:change` - изменение состава корзины товаров

#### События коммуникационного слоя
- `itemsList:change` - загрузка массива товаров
- `orderSend:success` - успешная отправка заказа на сервер
- `orderSend:error` - ошибка отправки заказа на сервер

#### События, возникающие при взаимодействии пользователя с интерфейсом (генерируются классами, отвечающими за представление)
- `gallery:click` - клик по товару в галереи для вызова карточки с подробной информации о товаре
- `preview:addToBasket` - добавление товара в корзину из карточки товара
- `headerBasket:click` - клик по иконке с корзиной для вызова корзины товаров
- `basket:deleteItem` - удаление товара в корзине
- `basket:order` - переход на следующий этап по главной кнопке из корзины
- `order:button` - переход на следующий этап по главной кнопке из окна выбора способов оплаты и ввода адреса
- `contacts:button` - переход на следующий этап по главной кнопке из окна ввода электронной почты и номера телефона
- `success:button` - закрытие модального окна с информацией о результате отправки заказа на сервер по его главной кнопке
